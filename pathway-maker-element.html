<script src="bower_components/stevia-elements/src/manager/stevia-manager.js"></script>

<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<script src="bower_components/cookies-js/dist/cookies.min.js"></script>
<script src="bower_components/crypto-js/core.js"></script>
<script src="bower_components/crypto-js/sha1.js"></script>
<script src="bower_components/crypto-js/md5.js"></script>
<script src="bower_components/async/dist/async.min.js"></script>

<link rel="import" href="bower_components/stevia-elements/src/stv-header.html">
<link rel="import" href="bower_components/stevia-elements/src/stv-application-behavior.html">
<link rel="import" href="bower_components/stevia-elements/src/stv-select.html">
<link rel="import" href="bower_components/stevia-elements/src/stv-select-box.html">
<link rel="import" href="bower_components/stevia-elements/src/stv-panel.html">
<link rel="import" href="bower_components/stevia-elements/src/dropdown/stv-dropdown.html">
<link rel="import" href="bower_components/stevia-elements/src/stv-feedback.html">
<link rel="import" href="bower_components/stevia-elements/src/stv-launcher/stv-launcher.html">

<link rel="import" href="bower_components/stevia-elements/src/table/stv-table.html">
<link rel="import" href="bower_components/stevia-elements/src/form/stv-file-origin.html">
<link rel="import" href="bower_components/stevia-elements/src/file/stv-file-browser.html">
<link rel="import" href="bower_components/stevia-elements/src/job/stv-job-browser.html">
<link rel="import" href="bower_components/stevia-elements/src/stv-cluster-status.html">

<script src="bower_components/network-viewer/conf/config.js"></script>
<link rel="import" href="bower_components/network-viewer/network-viewer.html">
<link rel="import" href="bower_components/pathway-viewer/pathway-viewer.html">


<dom-module id="pathway-maker-element">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
         :host {
            display: block;
            position: relative;
            cursor: default;
            font-size: 13px;
            background-color: var(--default-primary-color);
            height: 100%;
            width: 100%;
        }

        stv-header {
            position: absolute;
            top: 0;
        }

        .content {
            position: absolute;
            width: 100%;
            top: 50px;
        }

        #fileBrowserPanel {
            position: absolute;
            top: 0px;
            left: 0;
            width: 600px;
            height: 400px;
            min-width: 600px;
            min-height: 400px;
        }

        @media (max-width: 1100px) {
            .option-text {
                display: none;
            }
        }

        .userid {
            color: var(--accent-color);
            font-size: 16px;
        }

        #description {
            color: var(--accent-color);
            font-weight: normal;
        }

        #main {
            box-sizing: border-box;
            position: relative;
            width: 100%;
            @apply(--layout-horizontal);
            background-color: #eee;
            padding: 10px 8px;
        }

        #right {
            position: relative;
            box-sizing: border-box;
            width: calc(100% - 350px);
            height: 100%;
            margin: 0 0 0 10px;
            background-color: #fff;
        }

        #right-bar,
        #left-bar {
            position: relative;
            box-sizing: border-box;
            height: 28px;
            width: 100%;
            padding-bottom: 5px;
        }

        #right-bar *,
        #left-bar * {
            margin: 0 5px;
        }

        #left {
            position: relative;
            box-sizing: border-box;
            width: 350px;
            height: 100%;
            @apply(--layout-vertical);
            background-color: #fff;
        }

        network-viewer {
            box-sizing: border-box;
            height: calc(100vh - 82px);
            box-shadow: 0px 0px 2px 1px rgba(0, 0, 0, 0.2);
            border: 1px solid #ccc;
        }

        #fileBrowserLeft {
            box-sizing: border-box;
            height: calc(100vh - 82px);
            box-shadow: 0px 0px 2px 1px rgba(0, 0, 0, 0.2);
            border: 1px solid #ccc;
        }

        .button {
            color: var(--text-primary-color);
            background-color: var(--dark-button-color);
        }

        .button:hover {
            background-color: var(--light-button-color);
        }

        .button[data-disabled] {
            background-color: #ddd !important;
            color: #fff !important;
        }

        .button[data-disabled]:hover {
            background-color: #ddd !important;
        }

        #loading {
            z-index: 100000;
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: transparent;
            font-size: 18px;
        }

        stv-panel {
            box-shadow: 0px 0px 6px 3px rgba(0, 0, 0, 0.30)
        }
    </style>
    <template>

        <div id="main" class="content" menu-option="home">
            <div id="left">
                <stv-file-browser id="fileBrowserLeft" class="container flex" columns="{{fileColumns}}" hide-tree on-fileclick="handleFileSelect" on-openfolder="handleOpenFolder" on-filedelete="handleFileDelete" bioformats="{{bioformats}}" mode="file" search-by-type="{{browserFilterTypes}}" on-need-refresh="handleUserNeedRefresh" user-data="{{userData}}" hide-file-column hide-upload-btn hide-download-btn>
                    <!-- hide-filter-btns -->
                    <!-- <div class="custom-button button stv-btn stv-btn-shdw" file-ext="sif" on-click="handleSavePathway">
                        <i class="fa fa-cloud-upload"></i>
                    </div> -->
                </stv-file-browser>
            </div>
            <div id="right">
                <network-viewer hide-external hide-node-render hide-edge-render id="networkViewer" user-data="{{userData}}" on-need-refresh="handleUserNeedRefresh" on-startover="handleLoad" on-graphload="handleLoad" on-update-row="handleUpdateAttr" disable-context-menu on-rightclickvertex="handleRightClickVertex" on-rightclickedge="handleRightClickEdge" on-vertexeditionbar="handleVertexEditionBar" on-edgeeditionbar="handleEdgeEditionBar" on-importnodeattr="handleUpdateAttr" on-importedgeattr="handleUpdateAttr">
                </network-viewer>
                <stv-dropdown id="nodeDropdown">
                    <ul data-menu>
                        <li on-click="handleSetAsGene">Gene</li>
                        <li on-click="handleSetAsMetabolite">Metabolite</li>
                        <li on-click="handleSetAsFunction">Function</li>
                    </ul>
                </stv-dropdown>
                <stv-dropdown id="edgeDropdown">
                    <ul data-menu>
                        <li on-click="handleSetAsActivation">Activation</li>
                        <li on-click="handleSetAsInhibition">Inhibition</li>
                        <li on-click="handleSwapEdgeDirection">Swap direction</li>
                    </ul>
                </stv-dropdown>
            </div>
        </div>
        <div class="content" menu-option="home">
            <!-- <stv-panel id="fileBrowserPanel" hidden collapsible movable closable expandible resizable on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-cloud"></i>&nbsp; Browse my data
                </div>
                <stv-file-browser id="fileBrowser" class="container flex" on-fileselect="off" on-need-refresh="handleUserNeedRefresh" user-data="{{userData}}">
                </stv-file-browser>
            </stv-panel> -->

            <stv-panel id="createPathwayPanel" hidden fixed modal on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-plus"></i>&nbsp; Create new pathway
                </div>
                <form id="createForm" class="container flex" style="padding:30px 30px;width:300px;">
                    <label class="stv">Pathway name:</label>
                    <div>
                        <input id="pathwayNameField" class="stv" type="text" placeholder="name..." />
                    </div>
                    <br>
                    <label class="stv">Pathway id:</label>
                    <div>
                        <input id="pathwayIdField" class="stv" type="text" placeholder="id..." />
                    </div>
                    <br>
                    <label class="stv-control">
                        <input type="radio" name="createnetwork" value="current" checked="true">
                        <span>Make a copy from current network</span>
                    </label>
                    <label class="stv-control">
                        <input type="radio" name="createnetwork" value="empty">
                        <span>Create an empty pathway network</span>
                    </label>
                </form>
                <div class="footer horizontal layout center end-justified flex">
                    <div class="stv-btn stv-red stv-btn-shdw" style="width:100px;margin:5px;" on-click="handleCloseCreatePathway">Cancel</div>
                    <div class="stv-btn stv-blue stv-btn-shdw" style="width:100px;" on-click="handleCreatePathway">OK</div>
                </div>
            </stv-panel>
            <stv-panel id="exportPathwayPanel" hidden fixed modal on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-plus"></i>&nbsp; Export pathways
                </div>
                <form id="exportForm" class="container flex" style="padding:30px 30px;width:300px;">
                    <label class="stv-control">
                        <input type="radio" name="export" value="directory" checked="true">
                        <span>Current directory</span>
                    </label>
                    <label class="stv-control">
                        <input type="radio" name="export" value="file">
                        <span>Current pathway</span>
                    </label>
                </form>
                <div class="footer horizontal layout center end-justified flex">
                    <div class="stv-btn stv-red stv-btn-shdw" style="width:100px;margin:5px;" on-click="handleCloseExportPathway">Cancel</div>
                    <div class="stv-btn stv-blue stv-btn-shdw" style="width:100px;" on-click="handleExportPathway">OK</div>
                </div>
            </stv-panel>
            <stv-panel id="importPathwayPanel" hidden fixed modal on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-plus"></i>&nbsp; Import pathways
                </div>
                <form id="importForm" class="container flex" style="padding:30px 30px;width:300px;">
                    <label class="stv">Select file: </label>
                    <input hidden type="file" id="importInput" on-change="handleImportInputChange">
                    <div class="stv-btn stv-btn-shdw" id="importInputText" on-click="handleImportClick">Browse file...</div>
                    <div>
                        &nbsp;<span id="importInputText" style="margin:3px 4px;"></span>
                    </div>
                    <br>
                    <label class="stv">Extract folder: </label>
                    <label class="stv-control">
                        <input type="radio" name="extractFolder" value="current" checked="true">
                        <span>Use current folder for extraction.</span>
                    </label>
                    <label class="stv-control">
                        <input type="radio" name="extractFolder" value="create">
                        <span>Create new folder for extraction.</span>
                    </label>
                    <br>
                    <label class="stv">Overwrite/merge files: </label>
                    <label class="stv-control">
                        <input type="radio" name="overwrite" value="new" checked="true">
                        <span>Overwrite server files with uploaded files.</span>
                    </label>
                    <label class="stv-control">
                        <input type="radio" name="overwrite" value="old">
                        <span>Keep server files untouched.</span>
                    </label>
                </form>
                <div class="footer horizontal layout center end-justified flex">
                    <div class="stv-btn stv-red stv-btn-shdw" style="width:100px;margin:5px;" on-click="handleCloseImportPathway">Cancel</div>
                    <div class="stv-btn stv-blue stv-btn-shdw" style="width:100px;" on-click="handleImportPathway">OK</div>
                </div>
            </stv-panel>
            <stv-panel id="editPathwayInfoPanel" hidden fixed on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-pencil"></i>&nbsp; Edit pathway information
                </div>
                <stv-table id="tableInfo" class="container" enable-edit columns="{{infoColumns}}" data="{{infoData}}" style="width:400px;height:400px"></stv-table>

                <div class="footer horizontal layout center end-justified flex">
                    <div class="stv-btn stv-red stv-btn-shdw" style="width:100px;margin:5px;" on-click="">Cancel</div>
                    <div class="stv-btn stv-blue stv-btn-shdw" style="width:100px;" on-click="">OK</div>
                </div>
            </stv-panel>
        </div>

        <stv-header id="stvHeader" small-options selected-option="{{selectedOption}}" user-data="{{userData}}" on-login="handleLogin" on-logout="handleLogout">
            <div class="icon">
                <img src="images/Leaf_icon_03.svg" style="height: 45px;margin: 8px 3px 0 0;">
            </div>
            <div class="title horizontal layout center" style="margin-left:15px;">
                Pathway<span style="font-weight:normal;">Maker</span>
            </div>
            <span id="description" class="description">
                1.0
            </span>

            <div id="menu" class="menu vertical layout flex">
                <div class="horizontal layout center flex" style="padding-top:2px;">
                    <div title="" style="margin-left:15px;width:30px;">
                        <span hidden$="{{!loading}}" class="option-text"><i class="fa fa-circle-o-notch fa-spin"></i></span>
                    </div>
                    <div title="" class="option" hidden$="{{isNull(lastFile)}}" on-click="handleSavePathway">
                        <span class="option-text"><i class="fa fa-save"></i> Save</span>
                    </div>
                    <!-- <div title="" class="option" hidden$="{{isNull(lastFile)}}" on-click="handleMenuPanel" data-panel="editPathwayInfoPanel">
                        <span class="option-text"><i class="fa fa-pencil"></i> Edit</span>
                    </div> -->
                    <div style="margin-left:10px;"></div>
                    <div title="Last loaded pathway" style="font-weight:bold;font-size:16px;">
                        <span class="option-text">{{processName(lastFile)}} </span>
                    </div>
                </div>
                <div class="horizontal layout center flex" style="padding-bottom:2px;">
                    <div style="margin-left:15px;width:30px;"></div>
                    <div title="Browse my data" class="option" on-click="handleMenuPanel" login-visible data-panel="createPathwayPanel">
                        <i class="fa fa-plus"></i>
                        <span class="option-text">Create new...</span>
                    </div>
                    <div title="Import pathways folder" class="option" on-click="handleMenuPanel" login-visible data-panel="importPathwayPanel">
                        <i class="fa fa-cloud-upload"></i>
                        <span class="option-text">Import...</span>
                    </div>
                    <div title="Import pathways folder" class="option" on-click="handleMenuPanel" login-visible data-panel="exportPathwayPanel">
                        <i class="fa fa-cloud-download"></i>
                        <span class="option-text">Export...</span>
                    </div>
                    <!-- <div style="margin-left:20px;"></div>
                    <div title="Browse my data" class="option" on-click="handleMenuPanel" login-visible data-panel="fileBrowserPanel">
                        <i class="fa fa-cloud"></i>
                        <span class="option-text">My data</span>
                    </div> -->
                </div>
            </div>

            <!-- <stv-launcher class="launcher" dropdown-position="left" data-src="conf/test-apps.json">
                <i class="fa fa-th"></i>
            </stv-launcher> -->

            <!-- <stv-cluster-status id="clusterStatus" type="dark" class="cluster-status"></stv-cluster-status> -->

            <!-- <stv-dropdown dark class="helpmenu">
                <div data-button><i class="fa fa-question-circle"></i></div>
                <ul data-menu>
                    <a href="" target="_blank">
                        <li>
                            <i class="fa fa-book"></i> &nbsp; Documentation
                        </li>
                    </a>
                    <li on-mousedown="handleExample">
                        <i class="fa fa-lightbulb-o"></i> &nbsp; Run example
                    </li>
                    <li on-mousedown="handleFeedback">
                        <i class="fa fa-envelope-o" aria-hidden="true"></i> &nbsp; Send an email
                    </li>
                    <a href="http://gitlab.bioinfo.cipf.es/stevia/stevia-elements/issues" target="_blank">
                        <li>
                            <i class="fa fa-exclamation-circle" aria-hidden="true"></i> &nbsp; Go to git issue
                        </li>
                    </a>
                </ul>
            </stv-dropdown> -->
        </stv-header>

        <!-- <stv-footer menu-option="home,login,signup,profile,remember">
            Application Scaffold
            <br> Created by
            <span style="font-weight:bold;">Computational Genomics Department</span>
            <br> Principe Felipe Research Center, Valencia, Spain
            <br> 2016
        </stv-footer> -->
        <div id="loading" hidden$="{{!loading}}" class="horizontal layout center-justified stv-unselectable"></div>
    </template>

    <script>
        Polymer({
            is: "pathway-maker-element",
            behaviors: [StvApplicationBehavior],
            properties: {
                bioformats: {
                    type: Array,
                    notify: true,
                    value: [BIOFORMATS["SIMPLE_INTERACTION_FILE"]]
                },
                lastFile: {
                    type: Object,
                    value: null
                },
                lastFileChecksum: {
                    type: Object,
                    value: null
                },
                loading: {
                    type: Boolean,
                    value: false
                },
                browserFilterTypes: {
                    type: Array,
                    value: ['file', 'folder']
                },
                fileColumns: {
                    type: Array,
                    value: [{
                        title: 'Name',
                        name: 'pwname',
                        width: 145,
                        icon: 'fa-file-o',
                        enableSearch: true,
                        formula: function(f) {
                            if (f.type == 'FOLDER') {
                                return f.name;
                            } else {
                                if (f._pathwayname != null) {
                                    return f._pathwayname;
                                } else {
                                    return '';
                                }
                            }
                        }
                    }, {
                        title: 'Id',
                        name: 'pwid',
                        width: 80,
                        enableSearch: true,
                        formula: function(f) {
                            if (f.type == 'FOLDER') {
                                return '';
                            } else {
                                return f.name.substr(0, f.name.length - 4);
                            }
                        }
                    }, {
                        title: 'Date',
                        width: 70,
                        name: 'updatedAt',
                        formula: function(file) {
                            var date = new Date(Date.parse(file.updatedAt));
                            return date.getDate() + "/" + (date.getMonth() + 1) + "/" + date.getFullYear().toString().substr(2, 2);
                        }
                    }]
                },
                infoColumns: {
                    type: Array,
                    value: [{
                        title: 'Key',
                        width: 150,
                        name: 'key'
                    }, {
                        title: 'Value',
                        width: 250,
                        name: 'value'
                    }]
                },
                infoData: {
                    type: Array,
                    value: []
                }
            },
            ready: function() {
                var me = this;
                this.checkShowMenuOnLogin();
                this.createColumns();
                this.updateNodeAttributes();
                this.updateEdgeAttributes();
            },
            handleRightClickVertex: function(e) {
                this.$.edgeDropdown.hideMenu();
                this.$.nodeDropdown.showMenu(e.detail.e.x, e.detail.e.y);
            },
            handleRightClickEdge: function(e) {
                this.$.nodeDropdown.hideMenu();
                this.$.edgeDropdown.showMenu(e.detail.e.x, e.detail.e.y);
            },
            handleSetAsGene: function(e) {
                var vertex = this.$.networkViewer.lastContextVertex;
                if (vertex) {
                    vertex.attributes.shape = 'ellipse';
                    vertex.attributes.size = 40;
                    this.updateNodeAttributes();
                    // this.updateEdgeAttributes();
                }
            },
            handleSetAsMetabolite: function(e) {
                var vertex = this.$.networkViewer.lastContextVertex;
                if (vertex) {
                    vertex.attributes.shape = 'circle';
                    vertex.attributes.size = 25;
                    this.updateNodeAttributes();
                }
            },
            handleSetAsFunction: function(e) {
                var vertex = this.$.networkViewer.lastContextVertex;
                if (vertex) {
                    vertex.attributes.shape = 'rectangle';
                    vertex.attributes.size = 40;
                    this.updateNodeAttributes();
                }
            },
            handleSwapEdgeDirection: function(e) {
                var edge = this.$.networkViewer.lastContextEdge;
                if (edge) {
                    this.$.networkViewer.swapEdgeDirection(edge);
                    this.updateEdgeAttributes();
                }
            },
            handleSetAsActivation: function(e) {
                var edge = this.$.networkViewer.lastContextEdge;
                if (edge) {
                    edge.attributes.shape = 'directed';
                    this.updateEdgeAttributes();
                }
            },
            handleSetAsInhibition: function(e) {
                var edge = this.$.networkViewer.lastContextEdge;
                if (edge) {
                    edge.attributes.shape = 'inhibited';
                    this.updateEdgeAttributes();
                }
            },
            handleLoad: function(e) {
                this.set('lastFile', null);
                this.set('lastFileChecksum', null);
                this.set('infoData', []);
                this.createColumns();
                this.updateNodeAttributes();
                this.updateEdgeAttributes();
            },
            createColumns: function() {
                var vAttributes = [
                    'label',
                    'labelSize',
                    'opacity',
                    'shape',
                    'color',
                    'strokeColor',
                    'size',
                    'strokeSize'
                ];
                var vColumns = [];
                for (var i = 0; i < vAttributes.length; i++) {
                    var name = vAttributes[i];
                    vColumns.push(this._createColumn(name));
                }
                this.$.networkViewer.addVertexColumns(vColumns);

                var eAttributes = [
                    'label',
                    'labelSize',
                    'opacity',
                    'shaft',
                    'shape',
                    'bidirectional',
                    'color',
                    'size'
                ];
                var eColumns = [];
                for (var i = 0; i < eAttributes.length; i++) {
                    var name = eAttributes[i];
                    eColumns.push(this._createColumn(name));
                }
                this.$.networkViewer.addEdgeColumns(eColumns);
            },
            _createColumn: function(name) {
                return {
                    name: name,
                    title: stv.utils.capitalize(name),
                    type: "text",
                    formula: function(row) {
                        return row.attributes[this.name];
                    },
                    editFormula: function(row, newVal) {
                        row.attributes[this.name] = newVal;
                    }
                }
            },
            handleFileSelect: function(e) {
                var me = this;
                var file = e.detail.file;
                if (!this.loading && file != null) {
                    if (this.lastFile != null && stv.utils.endsWithIgnoreCase(file.name, '.sif')) {
                        if (stv.utils.endsWithIgnoreCase(this.lastFile.name, '.sif') && this.lastFile._id != file._id) {
                            this._isLastPathwayEqual(function(r) {
                                if (r == false) {
                                    new StvDialog({
                                        cancelText: 'No',
                                        okText: 'Yes'
                                    }).confirm('Do you want to save changes before select another pathway?', function(bool) {
                                        if (bool) {
                                            me._savePathway(me.lastFile, function() {
                                                me._selectFile(file);
                                            });
                                        } else {
                                            me._selectFile(file);
                                        }
                                    });
                                } else {
                                    me._selectFile(file);
                                }
                            })
                        }
                    } else {
                        me._selectFile(file);
                    }
                }
            },
            handleOpenFolder: function(e) {
                var me = this;
                var files = e.detail.files;
                var filteredFiles = e.detail.filteredFiles;
                var tasks = {};
                var sifFileMap = {};
                for (var i = 0; i < files.length; i++) {
                    var f = files[i];
                    if (stv.utils.endsWithIgnoreCase(f.name, '.info')) {
                        tasks[f._id] = this._createDownloadTask(f);
                    }
                }
                for (var i = 0; i < filteredFiles.length; i++) {
                    var f = filteredFiles[i];
                    if (stv.utils.endsWithIgnoreCase(f.name, '.sif')) {
                        sifFileMap[f.name] = f;
                    }
                }
                async.parallel(tasks, function(err, results) {
                    for (var fid in results) {
                        var fileContent = results[fid];
                        if(fileContent != ""){
                            var lines = fileContent.split('\n');
                            var oneLine = lines[1].split('\t');
                            var twoLine = lines[2].split('\t');
                            pwId = oneLine[1];
                            pwName = twoLine[1];
                            var f = sifFileMap[pwId + '.sif'];
                            if (f != null) {
                                f._pathwayname = pwName;
                            }
                        }
                    }
                    me.$.fileBrowserLeft.refreshFolderList();
                });
            },
            _selectFile: function(file) {
                var me = this;
                if (stv.utils.endsWithIgnoreCase(file.name, '.sif')) {
                    this.set('loading', true);
                    var prefixName = file.name.substr(0, file.name.length - 4);
                    var nattFile = null;
                    var eattFile = null;
                    var nbgFile = null;
                    var nvsFile = null;
                    var infoFile = null;
                    for (var i = 0; i < this.$.fileBrowserLeft.files.length; i++) {
                        var f = this.$.fileBrowserLeft.files[i];
                        if (f.name == prefixName + '.natt') {
                            nattFile = f;
                        }
                        if (f.name == prefixName + '.eatt') {
                            eattFile = f;
                        }
                        if (f.name == prefixName + '.eatt') {
                            eattFile = f;
                        }
                        if (f.name == prefixName + '.nbg') {
                            nbgFile = f;
                        }
                        if (f.name == prefixName + '.nvs') {
                            nvsFile = f;
                        }
                        if (f.name == prefixName + '.info') {
                            infoFile = f;
                        }
                    }
                    var tasks = {
                        sif: this._createDownloadTask(file),
                        natt: this._createDownloadTask(nattFile),
                        eatt: this._createDownloadTask(eattFile),
                        nbg: this._createDownloadTask(nbgFile),
                        nvs: this._createDownloadTask(nvsFile),
                        info: this._createDownloadTask(infoFile)
                    };
                    async.parallel(tasks, function(err, results) {
                        me.$.networkViewer.startOver();
                        var sif = results.sif;
                        var natt = results.natt;
                        var eatt = results.eatt;
                        var nbg = results.nbg;
                        var nvs = results.nvs;
                        var info = results.info;
                        if (sif) {
                            me.$.networkViewer.loadSif(sif);
                            me.$.networkViewer.lastLoadedFileName = file.name;
                            me.$.networkViewer.centerNetwork();
                        }
                        if (natt) {
                            me.$.networkViewer.loadNodeAttributes(natt, natt.charAt(0) != '#');
                            me.updateNodeAttributes();
                        } else {
                            me.$.networkViewer.setLayout('Force directed');
                        }
                        if (eatt) {
                            me.$.networkViewer.loadEdgeAttributes(eatt, eatt.charAt(0) != '#');
                            me.updateEdgeAttributes();
                        }
                        if (nbg) {
                            me.$.networkViewer.loadBackground(nbg);
                        }
                        if (nvs) {
                            me.$.networkViewer.loadVisualSettings(nvs);
                            me.$.networkViewer.applyVisualSets();
                        }
                        if (info) {
                            var infoData = me.$.tableInfo.parseDelimitedSeparatedValues(info, me.infoColumns);
                            infoData.shift();
                            me.set('infoData', infoData);
                        }
                        me.set('loading', false);

                        me.set('lastFile', file);

                        me.set('lastFileChecksum', me._createChecksum(sif, natt, eatt, nbg, nvs));
                    });
                } else {
                    me.set('lastFile', null);
                    me.set('lastFileChecksum', null);
                    me.set('infoData', []);
                }
            },
            _createChecksum: function(sif, natt, eatt, nbg, nvs) {
                return CryptoJS.MD5(sif).toString() +
                    CryptoJS.MD5(natt).toString() +
                    CryptoJS.MD5(eatt).toString() +
                    CryptoJS.MD5(nbg).toString() +
                    CryptoJS.MD5(nvs).toString();
            },
            handleUpdateAttr: function(e) {
                this.updateNodeAttributes();
                this.updateEdgeAttributes();
            },
            updateNodeAttributes: function() {
                var ncolmap = {};
                for (var i = 0; i < this.$.networkViewer.vertexColumns.length; i++) {
                    var col = this.$.networkViewer.vertexColumns[i];
                    ncolmap[col.name] = col;
                }
                // if (ncolmap['label'] != null) {
                //     this.$.networkViewer.setVertexDefaultLabelAttribute('label');
                // }
                if (ncolmap['labelSize'] != null) {
                    this.$.networkViewer.$.nodeRender.applyDirect('labelSize', 'labelSize');
                }
                if (ncolmap['opacity'] != null) {
                    this.$.networkViewer.$.nodeRender.applyDirect('opacity', 'opacity');
                }
                if (ncolmap['shape'] != null) {
                    this.$.networkViewer.$.nodeRender.applyDirect('shape', 'shape');
                }
                if (ncolmap['color'] != null) {
                    this.$.networkViewer.$.nodeRender.applyDirect('color', 'color');
                }
                if (ncolmap['strokeColor'] != null) {
                    this.$.networkViewer.$.nodeRender.applyDirect('strokeColor', 'strokeColor');
                }
                if (ncolmap['size'] != null) {
                    this.$.networkViewer.$.nodeRender.applyDirect('size', 'size');
                }
                if (ncolmap['strokeSize'] != null) {
                    this.$.networkViewer.$.nodeRender.applyDirect('strokeSize', 'strokeSize');
                }

                // me.$.networkViewer.$.nodeRender.applyDirect('exp', 'strokeColor');
                // me.$.networkViewer.$.nodeRender.applyDirect('diff.exp', 'color');
                // me.$.networkViewer.$.nodeRender.applyDirect('width', 'size');

                this.$.networkViewer.$.nodeAttributeEdit.update();
            },
            updateEdgeAttributes: function() {
                var ecolmap = {};
                for (var i = 0; i < this.$.networkViewer.edgeColumns.length; i++) {
                    var col = this.$.networkViewer.edgeColumns[i];
                    ecolmap[col.name] = col;
                }
                if (ecolmap['label'] != null) {
                    this.$.networkViewer.setEdgeDefaultLabelAttribute('label');
                }
                if (ecolmap['labelSize'] != null) {
                    this.$.networkViewer.$.edgeRender.applyDirect('labelSize', 'labelSize');
                }
                if (ecolmap['opacity'] != null) {
                    this.$.networkViewer.$.edgeRender.applyDirect('opacity', 'opacity');
                }
                if (ecolmap['shaft'] != null) {
                    this.$.networkViewer.$.edgeRender.applyDirect('shaft', 'shaft');
                }
                if (ecolmap['shape'] != null) {
                    this.$.networkViewer.$.edgeRender.applyDirect('shape', 'shape');
                }
                if (ecolmap['bidirectional'] != null) {
                    this.$.networkViewer.$.edgeRender.applyDirect('bidirectional', 'bidirectional');
                }
                if (ecolmap['color'] != null) {
                    this.$.networkViewer.$.edgeRender.applyDirect('color', 'color');
                }
                if (ecolmap['size'] != null) {
                    this.$.networkViewer.$.edgeRender.applyDirect('size', 'size');
                }
                // me.$.networkViewer.$.edgeRender.applyDirect('head', 'shape');

                this.$.networkViewer.$.edgeAttributeEdit.update();
            },
            handleFileDelete: function(e) {
                var me = this;
                var file = e.detail.file;
                if (!this.loading && file != null && file.bioformat == "SIMPLE_INTERACTION_FILE") {
                    this.set('loading', true);
                    var nattFile = null;
                    var eattFile = null;
                    var nbgFile = null;
                    var nvsFile = null;
                    var infoFile = null;
                    var prefixName = file.name.substr(0, file.name.length - 4);
                    for (var i = 0; i < this.$.fileBrowserLeft.files.length; i++) {
                        var f = this.$.fileBrowserLeft.files[i];
                        if (f.name == prefixName + '.natt') {
                            nattFile = f;
                        }
                        if (f.name == prefixName + '.eatt') {
                            eattFile = f;
                        }
                        if (f.name == prefixName + '.nbg') {
                            nbgFile = f;
                        }
                        if (f.name == prefixName + '.nvs') {
                            nvsFile = f;
                        }
                        if (f.name == prefixName + '.info') {
                            infoFile = f;
                        }
                    }
                    var tasks = {};
                    if (nattFile != null) {
                        tasks['natt'] = this._createDeleteTask(nattFile);
                    }
                    if (eattFile != null) {
                        tasks['eatt'] = this._createDeleteTask(eattFile);
                    }
                    if (nbgFile != null) {
                        tasks['nbg'] = this._createDeleteTask(nbgFile);
                    }
                    if (nvsFile != null) {
                        tasks['nvs'] = this._createDeleteTask(nvsFile);
                    }
                    if (infoFile != null) {
                        tasks['info'] = this._createDeleteTask(infoFile);
                    }
                    async.parallel(tasks, function(err, results) {
                        if (err) {
                            console.log(err);
                        } else {
                            console.log(results);
                            console.log('Delete done');
                            me.set('lastFile', null);
                            me.set('lastFileChecksum', null);
                            me.set('infoData', []);
                        }
                        me.set('loading', false);
                    });
                }
            },
            handleSavePathway: function(e) {
                var me = this;
                this._savePathway(this.lastFile, function() {
                    var nvsif = me.$.networkViewer.exportGraph();
                    var nvnatt = me.$.networkViewer.exportVertexAttributes();
                    var nveatt = me.$.networkViewer.exportEdgeAttributes();
                    var nvnbg = me.$.networkViewer.exportBackground();
                    var nvnvs = me.$.networkViewer.exportVisualSettings();

                    var cs = me._createChecksum(nvsif, nvnatt, nveatt, nvnbg, nvnvs);
                    me.set('lastFileChecksum', cs);
                });
            },
            _savePathway: function(file, cb) {
                var me = this;
                if (!this.loading && file != null && stv.utils.endsWithIgnoreCase(file.name, '.sif')) {
                    this.set('loading', true);
                    var nattFile = null;
                    var eattFile = null;
                    var nbgFile = null;
                    var nvsFile = null;
                    var infoFile = null;
                    var prefixName = file.name.substr(0, file.name.length - 4);
                    for (var i = 0; i < this.$.fileBrowserLeft.files.length; i++) {
                        var f = this.$.fileBrowserLeft.files[i];
                        if (f.name == prefixName + '.natt') {
                            nattFile = f;
                        }
                        if (f.name == prefixName + '.eatt') {
                            eattFile = f;
                        }
                        if (f.name == prefixName + '.nbg') {
                            nbgFile = f;
                        }
                        if (f.name == prefixName + '.nvs') {
                            nvsFile = f;
                        }
                        if (f.name == prefixName + '.info') {
                            infoFile = f;
                        }
                    }
                    var tasks = {};
                    if (file != null) {
                        tasks['sif'] = this._createSaveTask(file, this.$.networkViewer.exportGraph());
                    }
                    if (nattFile != null) {
                        tasks['natt'] = this._createSaveTask(nattFile, this.$.networkViewer.exportVertexAttributes());
                    }
                    if (eattFile != null) {
                        tasks['eatt'] = this._createSaveTask(eattFile, this.$.networkViewer.exportEdgeAttributes());
                    }
                    if (nbgFile != null) {
                        tasks['nbg'] = this._createSaveTask(nbgFile, this.$.networkViewer.exportBackground());
                    }
                    if (nvsFile != null) {
                        tasks['nvs'] = this._createSaveTask(nvsFile, this.$.networkViewer.exportVisualSettings());
                    }
                    if (infoFile != null) {
                        tasks['info'] = this._createSaveTask(infoFile, this.$.tableInfo.getDelimitedSeparatedValues(this.$.tableInfo.data, this.infoColumns));
                    }
                    //TODO? update info file
                    async.parallel(tasks, function(err, results) {
                        if (err) {
                            console.log(err);
                        } else {
                            console.log(results);
                            console.log('Save done');
                        }
                        me.set('loading', false);
                        cb();
                    });
                }
            },
            _isLastPathwayEqual: function(cb) {
                var me = this;
                var lastFile = this.lastFile;
                if (lastFile == null) {
                    cb(true);
                    return;
                }
                var nvsif = me.$.networkViewer.exportGraph();
                var nvnatt = me.$.networkViewer.exportVertexAttributes();
                var nveatt = me.$.networkViewer.exportEdgeAttributes();
                var nvnbg = me.$.networkViewer.exportBackground();
                var nvnvs = me.$.networkViewer.exportVisualSettings();

                var cs = this._createChecksum(nvsif, nvnatt, nveatt, nvnbg, nvnvs);

                if (cs != this.lastFileChecksum) {
                    cb(false);
                } else {
                    cb(true);
                }
            },
            handleCreatePathway: function() {
                var me = this;
                if (!this.loading && this.$.pathwayNameField.value != "" && this.$.pathwayIdField.value != null) {
                    this.set('loading', true);
                    var pwFieldId = this.$.pathwayIdField.value;
                    var pwFieldName = this.$.pathwayNameField.value;
                    var fileName = pwFieldId;
                    var infoContent = 'key\tvalue\n';
                    infoContent += 'id' + '\t' + pwFieldId + '\n';
                    infoContent += 'name' + '\t' + pwFieldName + '\n';

                    SteviaManager.getFileByPath(me.$.fileBrowserLeft.folder.path + '/' + fileName + '.sif', function(file) {
                        if (file != null) {
                            new StvDialog().alert('File already exists with that name. Please select a different name.');
                            me.set('loading', false);
                        } else {
                            if (me.$.createForm.elements['createnetwork'].value == 'empty') {
                                me.$.networkViewer.startOver();
                                me.set('lastFile', null);
                                me.set('lastFileChecksum', null);
                                me.set('infoData', []);
                                me.createColumns();
                            }

                            async.parallel([
                                me._createUplaodTask(fileName + '.sif', me.$.networkViewer.exportGraph(), 'SIMPLE_INTERACTION_FILE'),
                                me._createUplaodTask(fileName + '.natt', me.$.networkViewer.exportVertexAttributes()),
                                me._createUplaodTask(fileName + '.eatt', me.$.networkViewer.exportEdgeAttributes()),
                                me._createUplaodTask(fileName + '.nbg', me.$.networkViewer.exportBackground()),
                                me._createUplaodTask(fileName + '.nvs', me.$.networkViewer.exportVisualSettings()),
                                me._createUplaodTask(fileName + '.info', infoContent)
                            ], function(err, res) {
                                var sifFile = res[0];
                                var nattFile = res[1];
                                var eattFile = res[2];
                                var nbgFile = res[3];
                                var nvsFile = res[4];
                                var infoFile = res[5];
                                if (sifFile != null) {
                                    // var attr = {
                                    //     name: me.$.pathwayNameField.value,
                                    //     id: me.$.pathwayIdField.value
                                    // };
                                    // SteviaManager.updateFileAttributes(sifFile._id, {
                                    //     pathwayMaker: attr
                                    // }, function() {
                                    // me.$.createPathwayPanel.hide();
                                    // });
                                    me.$.createPathwayPanel.hide();
                                }
                                me.fire('need-refresh');
                                me.set('loading', false);
                            });
                        }
                    });

                }
            },
            handleCloseCreatePathway: function() {
                this.$.createPathwayPanel.hide();
            },
            handleCloseExportPathway: function() {
                this.$.exportPathwayPanel.hide();
            },
            handleCloseImportPathway: function() {
                this.$.importPathwayPanel.hide();
            },
            _createDownloadTask: function(file) {
                return function(cb) {
                    if (file != null) {
                        SteviaManager.files.download({
                            id: file._id,
                            request: {
                                success: function(response, req) {
                                    cb(null, response);
                                }
                            }
                        });
                    } else {
                        cb(null, null);
                    }
                }
            },
            _createUplaodTask: function(name, content, bioformat) {
                if (bioformat == null) {
                    bioformat = '';
                }
                var parentId = this.$.fileBrowserLeft.folder._id;
                return function(cb) {
                    if (name != null) {
                        var blob = new Blob([content], {
                            type: "text/plain"
                        });
                        SteviaManager.files.upload({
                            parentId: parentId,
                            file: blob,
                            name: name,
                            bioFormat: bioformat,
                            callbackProgress: function(chunk, total, response) {
                                // console.log(Math.round((chunk.id / total) * 100));
                                if (chunk.last) {
                                    var uploadedFile = response.file;
                                    cb(null, uploadedFile);
                                }
                            },
                            callbackExists: function(file) {
                                cb(null, file);
                            },
                            error: function(msg) {
                                console.log(msg);
                                cb(null, null);
                            }
                        });
                    } else {
                        cb(null, null);
                    }
                }
            },
            _createSaveTask: function(file, content) {
                return function(cb) {
                    if (file != null) {
                        SteviaManager.files.write({
                            id: file._id,
                            request: {
                                method: 'POST',
                                headers: {
                                    "Content-Type": "text/plain"
                                },
                                body: content,
                                success: function(response) {
                                    if (response.response[0].error == null) {
                                        cb(null);
                                    } else {
                                        console.log(response.response[0].error);
                                        cb(response.response[0].error);
                                    }
                                },
                                error: function() {
                                    cb('Server error, try again later.');
                                }
                            }

                        });
                    } else {
                        cb(null, null);
                    }
                }
            },
            _createDeleteTask: function(file) {
                return function(cb) {
                    if (file != null) {
                        SteviaManager.files.delete({
                            id: file._id,
                            request: {
                                success: function(response) {
                                    if (response.response[0].error == null) {
                                        cb(null);
                                    } else {
                                        console.log(response.response[0].error);
                                        cb(response.response[0].error);
                                    }
                                },
                                error: function() {
                                    cb('Server error, try again later.');
                                }
                            }
                        });
                    } else {
                        cb(null, null);
                    }
                }
            },
            handleImportClick: function(e) {
                this.$.importInput.value = null;
                this.$.importInputText.innerHTML = '';
                this.$.importInput.click();
            },
            _createSetBioformatTask: function(file, bioformat) {
                return function(cb) {
                    SteviaManager.files.setBioformat({
                        id: file._id,
                        query: {
                            bioformat: bioformat
                        },
                        request: {
                            success: function(response) {
                                if (response.response[0].error == null) {
                                    cb(null);
                                } else {
                                    console.log(response.response[0].error);
                                    cb(response.response[0].error);
                                }
                            },
                            error: function(response) {
                                cb('Server error, try again later.');
                            }
                        }
                    });
                }
            },
            handleImportInputChange: function(e) {
                this.$.importInputText.innerHTML = this.$.importInput.files[0].name;
            },
            handleImportPathway: function(e) {
                var me = this;
                var file = this.$.importInput.files[0];
                if (file != null) {
                    this.set('loading', true);
                    async.waterfall([
                        function(cb) {
                            var parentId = me.$.fileBrowserLeft.folder._id;
                            SteviaManager.files.upload({
                                parentId: parentId,
                                file: file,
                                name: file.name,
                                // bioFormat: bioformat,
                                extract: true,
                                deleteCompressed: true,
                                extractFolder: me.$.importForm.elements['extractFolder'].value == 'create',
                                overwriteFiles: me.$.importForm.elements['overwrite'].value == 'new',
                                callbackProgress: function(chunk, total, response) {
                                    // console.log(Math.round((chunk.id / total) * 100));
                                    if (chunk.last) {
                                        var uploadedFile = response.file;
                                        cb(null, uploadedFile);
                                    }
                                },
                                callbackExists: function(folder) {
                                    cb('File already exists.', file);
                                },
                                error: function(msg) {
                                    cb(msg, null);
                                }
                            });
                        },
                        function(folder, cb) {
                            SteviaManager.getPlainFolderFiles(folder._id, function(files) {
                                var tasks = [];
                                for (var i = 0; i < files.length; i++) {
                                    var f = files[i];
                                    if (stv.utils.endsWithIgnoreCase(f.name, '.sif') && f.bioformat == '') {
                                        tasks.push(me._createSetBioformatTask(f, 'SIMPLE_INTERACTION_FILE'));
                                    }
                                }
                                async.parallel(tasks, function(err, results) {
                                    cb(null)
                                });
                            });
                        }
                    ], function(err, res) {
                        if (err) {
                            console.log(err);
                        } else {
                            console.log('Import done');
                            me.$.importPathwayPanel.hide();
                        }
                        if (me.lastFile != null) {
                            me._selectFile(me.lastFile);
                        }
                        me.fire('need-refresh');
                        me.set('loading', false);
                    });
                }
            },
            handleExportPathway: function(e) {
                var parentId = this.$.fileBrowserLeft.folder._id;
                if (this.$.exportForm.elements['export'].value == 'directory') {
                    SteviaManager.downloadFolderFiles(parentId, '+(*.sif|*.natt|*.eatt|*.nbg|*.nvs|*.info)');
                } else {
                    if (this.lastFile != null) {
                        var prefixName = this.lastFile.name.substr(0, this.lastFile.name.length - 4);
                        var fileNames = [
                            prefixName + '.sif',
                            prefixName + '.natt',
                            prefixName + '.eatt',
                            prefixName + '.nbg',
                            prefixName + '.nvs',
                            prefixName + '.info'
                        ]
                        SteviaManager.downloadFolderFiles(parentId, '+(' + fileNames.join('|') + ')');
                        this.$.exportPathwayPanel.hide();
                    }
                }

            },
            processName: function(file) {
                if (file != null) {
                    return file.name.substr(0, file.name.length - 4) + '  ( ' + file.name + ' )';
                } else {
                    return '';
                }
            },

            /* editionbar Handlers*/
            handleVertexEditionBar: function(e) {
                var dp = e.detail.displayProperty;
                var v = e.detail.value;
                if (!isNaN(v)) {
                    v = parseFloat(v);
                }
                this._setSelectedVerticesDisplayAttr(dp, v);
            },
            handleEdgeEditionBar: function(e) {
                var dp = e.detail.displayProperty;
                var v = e.detail.value;
                if (!isNaN(v)) {
                    v = parseFloat(v);
                }
                this._setSelectedEdgesDisplayAttr(dp, v);
            },
            _setSelectedVerticesDisplayAttr: function(displayProperty, value) {
                for (var i = 0, li = this.$.networkViewer.selectedVertices.length; i < li; i++) {
                    var vertex = this.$.networkViewer.selectedVertices[i];
                    if (vertex) {
                        vertex.attributes[displayProperty] = value;
                    }
                }
                this.updateNodeAttributes();
            },
            _setSelectedEdgesDisplayAttr: function(displayProperty, value) {
                for (var i = 0, li = this.$.networkViewer.selectedEdges.length; i < li; i++) {
                    var edge = this.$.networkViewer.selectedEdges[i];
                    if (edge) {
                        edge.attributes[displayProperty] = value;
                    }
                }
                this.updateEdgeAttributes();
            },
            /** Layout Handlers **/

            handleLogin: function() {
                if (Cookies('bioinfo_user').indexOf("anonymous___") != -1) {
                    this.setMenu('home');
                } else {
                    this.setMenu('home');
                }
                if (this._lastLoggedPanel) {
                    this._lastLoggedPanel.show();
                    this._lastLoggedPanel = null;
                }
                if (this._lastLoggedMenu) {
                    this.setMenu(this._lastLoggedMenu);
                    this._lastLoggedMenu = null;
                }
                this.checkShowMenuOnLogin();
            },
            handleLogout: function() {
                this.setMenu('login');
                this.checkShowMenuOnLogin();
                this.set('lastFile', null);
                this.set('lastFileChecksum', null);
                this.set('infoData', []);
                this.$.networkViewer.startOver();
                this.createColumns();
            },
            handleUserNeedRefresh: function() {
                this.$.stvHeader.getUserInfo(true);
            },
            isNull: function(o) {
                return o == null;
            }
        });
    </script>
</dom-module>
